'use strict';function _toConsumableArray(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}var onvif=require('node-onvif'),arpScanner=require('arpscan/promise'),xs=require('xstream').default;function getONVIFStream(a){var b=function getStreams(c){return c.map(function(d){var j=new onvif.OnvifDevice({xaddr:'http://'+d.ip+function getPort(k){return a.passwords&&a.passwords[k]?':'+a.passwords[k].port:''}(d.ip)+'/onvif/device_service',user:function getUser(k){return a.passwords&&a.passwords[k]?a.passwords[k].user:a.user}(d.ip),pass:function getPass(k){return a.passwords&&a.passwords[k]?a.passwords[k].pass:a.pass}(d.ip)});return new Promise(function(k){j.init(function(m){var n=j.getCurrentProfile();if(m)k(null);else try{n&&n.video&&n.video.encoder&&n.video.encoder.framerate?k(Object.assign({},d,{stream:j.getUdpStreamUrl(),fps:n.video.encoder.framerate})):k(Object.assign({},d,{stream:j.getUdpStreamUrl()}))}catch(o){k(null)}})})})};return arpScanner(a).then(function(c){if(!0===a.password_override){var d=Object.keys(a.passwords),f=d.map(function(h){return Object.assign({},{ip:h},a.passwords[h])}),g=c.filter(function(h){return-1===d.indexOf(h.ip)});return[].concat(_toConsumableArray(g),_toConsumableArray(f))}return c}).then(function(c){return b(c)}).then(function(c){return Promise.all(c)}).then(function(c){return c.filter(function(d){return null!==d})})}function WrapONVIFStream(a){var b={};this.call=function(c,d){getONVIFStream(Object.assign({},a,{interface:d})).then(function(f){b[c](f)})},this.on=function(c,d){b[c]=d}}function makeONVIFStreamDriver(a){var c=new WrapONVIFStream(a);return function(d){return d.addListener({next:function next(f){c.call(f.category,f.interface)},error:function error(){},complete:function complete(){}}),{select:function select(f){return xs.create({start:function start(g){c.on(f,function(h){return g.next(h)})},stop:function stop(){}})}}}}module.exports=makeONVIFStreamDriver;